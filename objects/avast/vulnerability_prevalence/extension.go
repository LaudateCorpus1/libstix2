package vulnerability_prevalence

import (
	"time"

	"github.com/avast/libstix2/stixid"

	"github.com/avast/libstix2/objects/avast"
	"github.com/google/uuid"

	"github.com/avast/libstix2/objects/extensions/definition"
)

const (
	Name                      = "Vulnerability Prevalence Extension"
	PropVulnerabilityRef      = "x_avast_com_vulnerability_ref"
	PropRegionalPrevalenceMap = "x_avast_com_regional_prevalence_map"
)

var (
	UUID = uuid.NewSHA1(avast.Namespace, []byte(Name))
	Id   = stixid.BuildId("extension-definition", UUID)
)

func ExtensionDefinition() *definition.Definition {
	created, err := time.Parse(time.RFC3339, "2021-04-14T10:18:00+01:00")
	if err != nil {
		panic(err)
	}

	def := definition.New()
	def.SetID(Id)
	def.SetCreatedByRef(avast.IdentityId)
	def.SetName(Name)
	def.SetDescription("A vulnerability prevalence object defines how prevalent a vulnerability is occurring across both geographic and malware instances.")
	def.Version = "1.0"
	def.SetCreated(created)
	def.SetModified(created)
	def.Schema = "" // TODO
	def.ExtensionTypes = append(def.ExtensionTypes, definition.ExtensionProperty)
	def.ExtensionProperties = []string{PropVulnerabilityRef, PropRegionalPrevalenceMap}
	return def
}

type VulnerabilityPrevalence struct {
	VulnerabilityRef      string           `json:"x_avast_com_vulnerability_ref,omitempty"`
	RegionalPrevalenceMap map[string]int64 `json:"x_avast_com_regional_prevalence_map,omitempty"`
}
